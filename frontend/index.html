<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive xG Predictor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/loading_overlay.css">
    <style>
        /* Base font for the page */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 antialiased">
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-message">Initialising...</p>
    </div>
    <nav class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-slate-900">Alex's xG Plotter</a>
            <!-- Desktop Navigation -->
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors duration-200">Home</a>
                <a href="heatmap.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors duration-200">Heatmaps</a>
                <a href="plotter.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors duration-200">Plotter</a>
            </div>
            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-slate-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white shadow-inner">
            <a href="index.html" class="block py-2 px-4 text-slate-700 hover:bg-slate-100">Home</a>
            <a href="heatmap.html" class="block py-2 px-4 text-slate-700 hover:bg-slate-100">Heatmaps</a>
            <a href="plotter.html" class="block py-2 px-4 text-slate-700 hover:bg-slate-100">Plotter</a>
        </div>
    </nav>

    <!-- Main container for the entire application layout -->
    <div class="container mx-auto p-4 lg:p-8">

        <!-- Header -->
        <header class="mb-6 text-center lg:text-left">
            <h1 class="text-4xl font-bold text-slate-900">Explore the Model</h1>
            <p class="mt-1 text-lg text-slate-600">Click on the pitch to plot a shot and get its predicted xG value. <span class="font-semibold">The direction of attack is left to right.</span></p>
        </header>

        <!-- Main Content Area: Flexbox for two-column layout on large screens -->
        <main class="flex flex-col lg:flex-row lg:gap-8">

            <!-- Left Column: Contains the pitch visualization and info display -->
            <div class="lg:w-3/4 w-full">
                <div id="pitch-container" class="w-full bg-white shadow-lg rounded-lg overflow-hidden relative">
                    <canvas id="football-pitch" class="block w-full h-auto cursor-crosshair"></canvas>
                </div>

            </div>

            <!-- Right Column: Contains user controls -->
            <aside class="lg:w-1/4 w-full mt-6 lg:mt-0">
                <div class="bg-white p-6 rounded-lg shadow-lg sticky top-8">
                    <!-- Display for plotted point coordinates and xG value -->
                    <div id="plot-info" class="mb-4 flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-md min-h-[100px]">
                        <div id="xg-display" class="mt-2 text-center">
                            <span class="text-sm text-slate-500">Predicted xG</span>
                            <p id="xg-value" class="text-3xl font-bold text-blue-600">Click on the pitch to plot a point.</p>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 border-b border-slate-200 pb-3 mb-4">Controls</h2>

                    <!-- Situation Filter -->
                    <div class="mb-4">
                        <label for="situation-select" class="block text-sm font-medium text-slate-600 mb-1">Situation</label>
                        <select id="situation-select" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">All Situations</option>
                            <option value="OpenPlay">Open Play</option>
                            <option value="SetPiece">Set Piece</option>
                            <option value="DirectFreekick">Direct Free Kick</option>
                            <option value="FromCorner">From Corner</option>
                            <option value="Penalty">Penalty</option>
                        </select>
                    </div>

                    <!-- Shot Type Filter -->
                    <div class="mb-6">
                        <label for="shot-type-select" class="block text-sm font-medium text-slate-600 mb-1">Shot Type</label>
                        <select id="shot-type-select" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">All Shot Types</option>
                            <option value="Head">Head</option>
                            <option value="RightFoot">Right Foot</option>
                            <option value="LeftFoot">Left Foot</option>
                            <option value="OtherBodyPart">Other Body Part</option>
                        </select>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Text Content Section -->
        <section class="mt-8 bg-white shadow-lg rounded-lg p-6 lg:p-8">
            <h2 class="text-3xl font-bold text-slate-900 mb-4">From Raw Data to Probabilistic xG Mapping</h2>
            <div class="text-slate-700 space-y-6 text-base leading-relaxed">
                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">What is Expected Goals (xG)?</h3>
                    <p>
                        Expected Goals, or xG, is a metric in football analytics that quantifies the quality of a goal-scoring opportunity. Rather than simply counting shots, xG assigns a probability to each attempt, representing how likely it was to result in a goal. A shot with an xG of 0.1 is expected to be scored 10% of the time, whilst a close-range tap-in might carry an xG of 0.9.
                    </p>
                    <p class="mt-2">
                        This enables a more nuanced analysis of team and player performance, looking beyond the luck often inherent in a final scoreline. A team that consistently creates high-quality chances is likely performing well even when the goals are not coming. This interactive plotter is built on a bespoke xG model trained from the ground up.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 1: Gathering the Data</h3>
                    <p>
                        Every good model starts with good data. The foundation of this project is a dataset of hundreds of thousands of shots, scraped from the public football analytics website <a href="https://understat.com/" target="_blank" class="text-blue-600 hover:underline">Understat</a>. A custom Python script gathers data across multiple seasons from Europe's top leagues, including the Premier League, La Liga and the Bundesliga. It extracts detailed shot-level data from match pages, capturing everything from pitch coordinates to game situation, and saves it for the next stage.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 2: Preparing the Data</h3>
                    <p>
                        Raw scraped data is rarely clean. A cleansing step handles inconsistencies before the dataset moves into <span class="font-semibold">feature engineering</span>. The raw X and Y coordinates of a shot are useful on their own, but more powerful predictive features can be derived from them. Key engineered features include:
                    </p>
                    <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                        <li><span class="font-semibold">Distance to Goal:</span> The Euclidean distance from the shot location to the centre of the goal.</li>
                        <li><span class="font-semibold">Angle to Goal:</span> The angle in radians that the shooter has on goal, calculated using vectors to each goalpost. A wider angle generally represents a better chance.</li>
                    </ul>
                    <p class="mt-2">
                        Categorical variables such as <span class="font-semibold">Situation</span> (e.g. Open Play, Set Piece) and <span class="font-semibold">Shot Type</span> (e.g. Head, Right Foot) are converted to a numerical format using one-hot encoding so the model can interpret them correctly.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 3: Training the Models</h3>
                    <p>
                        With a preprocessed dataset in place, the next step is training the predictive models. This project uses <span class="font-semibold">Logistic Regression</span>, a robust and interpretable algorithm well-suited to binary classification tasks like predicting a goal (1) or no goal (0).
                    </p>
                    <p class="mt-2">
                        Rather than a single general-purpose model, four distinct models are trained to provide more specialised predictions. The correct model is selected automatically based on the inputs provided in the Controls panel:
                    </p>
                    <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                        <li><span class="font-semibold">Basic Model:</span> Uses only location-based features (coordinates, distance and angle).</li>
                        <li><span class="font-semibold">Situation Model:</span> Adds the game situation (e.g. Open Play, Penalty).</li>
                        <li><span class="font-semibold">Shot Type Model:</span> Adds information about how the shot was taken (e.g. Head, Left Foot).</li>
                        <li><span class="font-semibold">Advanced Model:</span> The most comprehensive model, combining all available features for the most detailed predictions.</li>
                    </ul>
                    <p class="mt-2">
                        Each model is trained using <code class="bg-slate-200 rounded px-1 py-0.5 text-sm">scikit-learn</code>, with hyperparameters tuned through randomised search and cross-validation.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 4: Pre-calculating Heatmaps</h3>
                    <p>
                        The Heatmaps page visualises xG values across the entire pitch. Computing these on demand for every visitor would be slow and wasteful, so a dedicated script (<code class="bg-slate-200 rounded px-1 py-0.5 text-sm">generate_heatmaps.py</code>) runs as part of the data pipeline to pre-calculate them.
                    </p>
                    <p class="mt-2">
                        The script iterates over a fine grid of pitch coordinates and calculates the xG at each point for every combination of situation and shot type. The results are saved to a single JSON file. When a filter is selected on the Heatmaps page, the browser reads the relevant pre-calculated grid directly from that file with no server round-trip required.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 5: Exporting Models to ONNX for the Browser</h3>
                    <p>
                        The trained <code class="bg-slate-200 rounded px-1 py-0.5 text-sm">scikit-learn</code> pipelines cannot run natively in a browser, so the final step of the data pipeline converts each one to the <span class="font-semibold">ONNX</span> (Open Neural Network Exchange) format using <code class="bg-slate-200 rounded px-1 py-0.5 text-sm">skl2onnx</code>. The resulting <code class="bg-slate-200 rounded px-1 py-0.5 text-sm">.onnx</code> files are written directly into the frontend directory alongside the heatmap JSON.
                    </p>
                    <p class="mt-2">
                        The site originally used a Python Flask API hosted on Render to serve predictions. Render's free tier spins down inactive instances after a period of inactivity, which meant every first visit triggered a cold start that could take upwards of 60 seconds before the page became usable. Migrating to in-browser inference via <span class="font-semibold">ONNX Runtime Web</span> eliminated that problem entirely. Predictions now run locally in the browser using the exported model files, with no server involved at all.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 6: Deployment</h3>
                    <p>
                        Because all inference happens client-side, the entire application is served as a static site via <a href="https://pages.github.com/" target="_blank" class="text-blue-600 hover:underline">GitHub Pages</a>. There is no backend to maintain or host. The ONNX model files and heatmap data are committed to the repository as static assets and served directly to the browser alongside the HTML, CSS and JavaScript.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-slate-800 mb-2">Step 7: Explore the Code</h3>
                    <p>
                        The full project, from the data pipeline to the frontend, is open source. The repository includes the scraping scripts, feature engineering, model training, ONNX export pipeline and all frontend code.
                    </p>
                    <p class="mt-4 text-center">
                        <a href="https://github.com/ATRedshaw/Redshaw-xG" target="_blank" class="inline-block bg-slate-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition-colors duration-300 shadow-md">
                            View on GitHub
                        </a>
                    </p>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.1/dist/ort.min.js"></script>
    <script src="js/xg_inference.js"></script>
    <script src="js/index.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/health_check.js"></script>
</body>
</html>